# Agent Development Guidelines

This document provides guidelines for AI agents working on this Fantasy Basketball Service project.

## Project Overview

This is a Fantasy Basketball Service built with Flask that provides:
- Player scouting and analysis
- Week-by-week predictions
- Team roster management
- Free agent transaction scheduling
- League statistics and analytics

Remote service: https://hcheng.ngrok.app

## Authentication & API Keys

### API Token Management
- The service uses `.api_token.json` file to store API token information
- API keys are managed through `auth/api_key.py` (APIKeyManager class)
- API keys can be provided via:
  - Bearer Token: `Authorization: Bearer <key>`
  - Header: `X-API-Key: <key>`
  - Query param: `?api_key=<key>`
  - Request body: `{"api_key": "<key>"}`

### Session Credentials
- **Do NOT save API tokens or credentials permanently** in any files or codebase
- At the beginning of each session, if no API key is available:
  1. Prompt the user for their API token
  2. Use it in-memory for the session only
  3. Discard it when the session ends
- Sensitive files to keep private: `.api_token.json`, `.env`, `.api_keys.json`

## Development Workflow

### Integration Testing
1. **Test Structure**: Create integration tests in `tests/` directory
   - Name format: `test_*.py`
   - Use pytest framework (existing tests use unittest, but pytest is compatible)
   
2. **Local Testing**:
   - Tests should run against a local service instance
   - Can be run with: `python -m pytest tests/` or `python -m unittest discover tests/`

3. **Remote Service Testing**:
   - Remote endpoint: `https://hcheng.ngrok.app`
   - All tests must pass with the actual remote service before deployment
   - Use API keys for authenticated endpoints

### Version Control

1. **Current Branch**: Currently on `docker_dev` branch
   - Do NOT commit to master without explicit approval
   - If not on master, stay on the current branch (docker_dev)
   
2. **Commit Process**:
   - Before pushing, ensure all tests pass locally
   - Use clear, descriptive commit messages
   - Add changes to git with `git add`

3. **Push Process**:
   - For development work: push to current branch (docker_dev)
   - After pushing, prompt the user to:
     ```bash
     git pull
     # Restart the remote service (user's responsibility)
     ```

4. **File Management**:
   - Files like `.agent.md` should be added to git
   - Use: `git add .agent.md && git commit -m "Add agent development guidelines"`

## API Endpoints

Key endpoints for testing (from `app.py`):

| Endpoint | Method | Auth | Purpose |
|----------|--------|------|---------|
| `/` | GET | No | Root endpoint - API info |
| `/api/v1/health` | GET | No | Health check |
| `/api/v1/predictions/calculate` | POST | Yes | Calculate week predictions |
| `/api/v1/predictions/week-analysis` | POST | Yes | Detailed week analysis |
| `/api/v1/team/{team_id}` | POST | Yes | Get team info |
| `/api/v1/team/{team_id}/roster` | POST | Yes | Get team roster |
| `/api/v1/players-playing/{scoring_period}` | POST | Yes | Get active players |
| `/api/v1/scoreboard/{week_index}` | POST | Yes | Get week scoreboard |

## Code Organization

```
├── auth/                 # Authentication & API key management
│   ├── api_key.py       # APIKeyManager class
│   ├── decorators.py    # @require_api_key, @optional_api_key
│   └── admin.py         # Admin authentication
├── predict/             # Prediction logic
├── scout/               # Player/team scouting
├── line_up/             # Lineup management
├── scheduling/          # Free agent transactions
├── common/              # Shared utilities
├── utils/               # Utility functions
└── tests/               # Unit and integration tests
```

## Common Tasks

### Adding a New Endpoint
1. Define the route in `app.py`
2. Add `@require_api_key` or `@optional_api_key` decorator as needed
3. Add `@require_league` if it needs league data
4. Create corresponding test in `tests/`
5. Document in this file

### Testing Against Remote Service
1. Obtain API token from user at session start
2. Use the token to authenticate requests
3. Point tests to `https://hcheng.ngrok.app`
4. Run tests to verify functionality

### Deploying Changes
1. Create integration tests for changes
2. Run tests locally (and against remote if applicable)
3. Commit with clear message
4. Push to current branch
5. Prompt user to pull and restart service

## Best Practices

1. **Error Handling**: Always check API responses for errors before processing
2. **Rate Limiting**: Be aware of API rate limits (100 requests/hour by default)
3. **League State**: League is loaded lazily on first request, handle `503` responses
4. **Testing**: Write tests that work independently and don't depend on external state
5. **Temporary Files**: Clean up any temporary test files with `tmp_rovodev_` prefix
6. **Documentation**: Update this file if adding new development practices

## Troubleshooting

### League Not Loading
- Check that `.env` has `ESPN_S2`, `SWID`, and `LEAGUE_ID`
- Service returns `503` if league initialization fails
- Check logs for detailed error messages

### API Key Issues
- Verify key is not revoked
- Check rate limit hasn't been exceeded
- Ensure key is active in `.api_keys.json`

### Remote Service Connection
- Verify ngrok tunnel is active
- Check that `https://hcheng.ngrok.app` is accessible
- Network issues may cause temporary failures; retry with backoff

## Agent Session Guidelines

1. **Session Start**:
   - If no API token available, ask user for one
   - Keep token in-memory only
   
2. **Session Work**:
   - Create integration tests as needed
   - Run tests against both local and remote services
   - Commit changes with clear messages
   
3. **Session End**:
   - Push changes to current branch
   - Provide instructions for user to pull and restart
   - Do not leave credentials in any files
   - Clean up temporary files

